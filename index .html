
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>SolTalk</title>
    <style>
        body {
            background-color: #0d0d0d;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 30px;
        }
        input, textarea, button {
            margin: 10px;
            padding: 10px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
        }
        input, textarea {
            width: 300px;
        }
        button {
            background-color: #7a2ff7;
            color: white;
            cursor: pointer;
        }
        #wallet-address {
            margin-top: 15px;
            color: #ccc;
            font-size: 14px;
        }
        #messaging-form {
            margin-top: 20px;
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
    <h1>SolTalk</h1>
    <button id="connect-button">Connect Wallet</button>
    <div id="wallet-address"></div>

    <div id="messaging-form" style="display: none;">
        <input id="recipient-address" type="text" placeholder="Adresse Solana du destinataire" /><br>
        <input id="recipient-alias" type="text" placeholder="Alias (facultatif)" /><br>
        <textarea id="message-content" placeholder="Écris ton message ici..." rows="6"></textarea><br>
        <button onclick="sendMessage()">Envoyer</button>
    </div>

    <script>
        const connectButton = document.getElementById('connect-button');
        const addressDisplay = document.getElementById('wallet-address');
        const form = document.getElementById('messaging-form');

        const supabase = supabase.createClient(
            'https://wvdqwrheipulozuzdlxj.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind2ZHF3cmhlaXB1bG96dXpkbHhqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyNDgzMzMsImV4cCI6MjA2NjgyNDMzM30.2XXmz9Zh_oeUdr7STD8kha_LaCr5KtWaslbmCowFwMI'
        );

        async function connectWallet() {
            if ('solana' in window) {
                const provider = window.solana;
                if (provider.isPhantom) {
                    try {
                        const resp = await provider.connect();
                        const address = resp.publicKey.toString();
                        addressDisplay.innerText = 'Connected: ' + address;
                        form.style.display = 'block';
                    } catch (err) {
                        console.error('Connection failed', err);
                    }
                } else {
                    alert('Phantom Wallet not found. Please install it.');
                }
            } else {
                alert('Solana wallet not found. Please install Phantom.');
            }
        }

        connectButton.addEventListener('click', connectWallet);

        async function sendMessage() {
            const to = document.getElementById('recipient-address').value;
            const alias = document.getElementById('recipient-alias').value;
            const content = document.getElementById('message-content').value;
            const from = window.solana.publicKey.toString();

            if (!to || !content) {
                alert("Adresse et message requis.");
                return;
            }

            const { data, error } = await supabase.from('messages').insert([
                { from, to, alias, content, date: new Date().toISOString() }
            ]);

            if (error) {
                alert("Erreur lors de l'envoi du message.");
                console.error(error);
            } else {
                alert("Message envoyé !");
                document.getElementById('recipient-address').value = '';
                document.getElementById('recipient-alias').value = '';
                document.getElementById('message-content').value = '';
            }
        }
    </script>
</body>
</html>
